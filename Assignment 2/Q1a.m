%Assuming a full K matrix, use 5 perpendicularity relations between vanishing points to compute camera matrix.

%5 perpendicular directions:
%p1 = []; p2 = []; l1 = cross(p1,p2); p3 = []; p4 = []; l2 = cross(p3,p4); v1 = cross(l1,l2); v1 = v1/v1(3);
%p1 = []; p2 = []; l1 = cross(p1,p2); p3 = []; p4 = []; l2 = cross(p3,p4); v2 = cross(l1,l2); v2 = v2/v2(3);

%p1 = []; p2 = []; l1 = cross(p1,p2); p3 = []; p4 = []; l2 = cross(p3,p4); v3 = cross(l1,l2); v3 = v3/v3(3);
%p1 = []; p2 = []; l1 = cross(p1,p2); p3 = []; p4 = []; l2 = cross(p3,p4); v4 = cross(l1,l2); v4 = v4/v4(3);

%p1 = []; p2 = []; l1 = cross(p1,p2); p3 = []; p4 = []; l2 = cross(p3,p4); v5 = cross(l1,l2); v5 = v5/v5(3);
%p1 = []; p2 = []; l1 = cross(p1,p2); p3 = []; p4 = []; l2 = cross(p3,p4); v6 = cross(l1,l2); v6 = v6/v6(3);

%p1 = []; p2 = []; l1 = cross(p1,p2); p3 = []; p4 = []; l2 = cross(p3,p4); v7 = cross(l1,l2); v7 = v7/v7(3);
%p1 = []; p2 = []; l1 = cross(p1,p2); p3 = []; p4 = []; l2 = cross(p3,p4); v8 = cross(l1,l2); v8 = v8/v8(3);

%p1 = []; p2 = []; l1 = cross(p1,p2); p3 = []; p4 = []; l2 = cross(p3,p4); v9 = cross(l1,l2); v9 = v9/v9(3);
%p1 = []; p2 = []; l1 = cross(p1,p2); p3 = []; p4 = []; l2 = cross(p3,p4); v10 = cross(l1,l2); v10 = v10/v10(3);

T = [1 0 0;0 1 0;0 0 1];

%img1
%imshow('Images/img1.jpg');
p1 = [324,1836,1]; p2 = [956,1844,1]; l1 = cross(p1,p2); p3 = [260,2324,1]; p4 = [1108,2308,1]; l2 = cross(p3,p4); v1 = cross(l1,l2); v1 = v1/v1(3); v1 = T*v1';
p1 = [1452,2428,1]; p2 = [1820,3388,1]; l1 = cross(p1,p2); p3 = [4076,2268,1]; p4 = [4780,3172,1]; l2 = cross(p3,p4); v2 = cross(l1,l2); v2 = v2/v2(3); v2 = T*v2';

p1 = [1524,1556,1]; p2 = [1708,732,1]; l1 = cross(p1,p2); p3 = [4076,1548,1]; p4 = [4516,532,1]; l2 = cross(p3,p4); v3 = cross(l1,l2); v3 = v3/v3(3); v3 = T*v3';
p1 = [1452,2428,1]; p2 = [1820,3388,1]; l1 = cross(p1,p2); p3 = [4076,2268,1]; p4 = [4780,3172,1]; l2 = cross(p3,p4); v4 = cross(l1,l2); v4 = v4/v4(3); v4 = T*v4';

p1 = [324,1836,1]; p2 = [956,1844,1]; l1 = cross(p1,p2); p3 = [260,2324,1]; p4 = [1108,2308,1]; l2 = cross(p3,p4); v5 = cross(l1,l2); v5 = v5/v5(3); v5 = T*v5';
p1 = [1524,1556,1]; p2 = [1708,732,1]; l1 = cross(p1,p2); p3 = [4076,1548,1]; p4 = [4516,532,1]; l2 = cross(p3,p4); v6 = cross(l1,l2); v6 = v6/v6(3); v6 = T*v6';

p1 = [508,164,1]; p2 = [724,740,1]; l1 = cross(p1,p2); p3 = [364,1220,1]; p4 = [540,1716,1]; l2 = cross(p3,p4); v7 = cross(l1,l2); v7 = v7/v7(3); v7 = T*v7';
p1 = [356,1220,1]; p2 = [516,204,1]; l1 = cross(p1,p2); p3 = [540,1716,1]; p4 = [732,788,1]; l2 = cross(p3,p4); v8 = cross(l1,l2); v8 = v8/v8(3); v8 = T*v8';

p1 = [76,3108,1]; p2 = [484,3116,1]; l1 = cross(p1,p2); p3 = [132,2780,1]; p4 = [676,2756,1]; l2 = cross(p3,p4); v9 = cross(l1,l2); v9 = v9/v9(3); v9 = T*v9';
p1 = [476,3260,1]; p2 = [348,3892,1]; l1 = cross(p1,p2); p3 = [924,3036,1]; p4 = [724,3892,1]; l2 = cross(p3,p4); v10 = cross(l1,l2); v10 = v10/v10(3); v10 = T*v10';

%checkerboard images
%imshow('Images/cb1.jpg');
p1 = [2964,1508,1]; p2 = [2724,2020,1]; l1 = cross(p1,p2); p3 = [4180,1836,1]; p4 = [3980,2588,1]; l2 = cross(p3,p4); v1 = cross(l1,l2); v1 = v1/v1(3); v1 = T*v1';
p1 = [2284,1892,1]; p2 = [3580,2276,1]; l1 = cross(p1,p2); p3 = [2588,1372,1]; p4 = [3780,1724,1]; l2 = cross(p3,p4); v2 = cross(l1,l2); v2 = v2/v2(3); v2 = T*v2';

p1 = [2540,2396,1]; p2 = [3820,2052,1]; l1 = cross(p1,p2); p3 = [2188,1964,1]; p4 = [3412,1652,1]; l2 = cross(p3,p4); v3 = cross(l1,l2); v3 = v3/v3(3); v3 = T*v3';
p1 = [2740,2612,1]; p2 = [2180,1966,1]; l1 = cross(p1,p2); p3 = [4060,2260,1]; p4 = [3228,1492,1]; l2 = cross(p3,p4); v4 = cross(l1,l2); v4 = v4/v4(3); v4 = T*v4';

p1 = [2260,2036,1]; p2 = [2124,2508,1]; l1 = cross(p1,p2); p3 = [4188,2500,1]; p4 = [4084,1884,1]; l2 = cross(p3,p4); v5 = cross(l1,l2); v5 = v5/v5(3); v5 = T*v5';
p1 = [2108,2492,1]; p2 = [3660,2508,1]; l1 = cross(p1,p2); p3 = [2300,1876,1]; p4 = [3636,1892,1]; l2 = cross(p3,p4); v6 = cross(l1,l2); v6 = v6/v6(3); v6 = T*v6';

p1 = [2220,1900,1]; p2 = [2260,2484,1]; l1 = cross(p1,p2); p3 = [3604,1660,1]; p4 = [3884,2828,1]; l2 = cross(p3,p4); v7 = cross(l1,l2); v7 = v7/v7(3); v7 = T*v7';
p1 = [3884,2828,1]; p2 = [2284,2812,1]; l1 = cross(p1,p2); p3 = [2172,1612,1]; p4 = [3596,1644,1]; l2 = cross(p3,p4); v8 = cross(l1,l2); v8 = v8/v8(3); v8 = T*v8';

p1 = [2852,700,1]; p2 = [2108,2060,1]; l1 = cross(p1,p2); p3 = [4468,924,1]; p4 = [3628,2444,1]; l2 = cross(p3,p4); v9 = cross(l1,l2); v9 = v9/v9(3); v9 = T*v9';
p1 = [1804,2532,1]; p2 = [2940,2876,1]; l1 = cross(p1,p2); p3 = [2868,700,1]; p4 = [4028,868,1]; l2 = cross(p3,p4); v10 = cross(l1,l2); v10 = v10/v10(3); v10 = T*v10';

%img7
%imshow('Images/img7.png');
p1 = [40,150,1]; p2 = [94,349,1]; l1 = cross(p1,p2); p3 = [415,69,1]; p4 = [424,232,1]; l2 = cross(p3,p4); v1 = cross(l1,l2); v1 = v1/v1(3); v1 = T*v1';
p1 = [118,76,1]; p2 = [328,30,1]; l1 = cross(p1,p2); p3 = [194,378,1]; p4 = [358,330,1]; l2 = cross(p3,p4); v2 = cross(l1,l2); v2 = v2/v2(3); v2 = T*v2';

p1 = [274,513,1]; p2 = [373,370,1]; l1 = cross(p1,p2); p3 = [664,654,1]; p4 = [712,498,1]; l2 = cross(p3,p4); v3 = cross(l1,l2); v3 = v3/v3(3); v3 = T*v3';
p1 = [286,604,1]; p2 = [539,693,1]; l1 = cross(p1,p2); p3 = [455,352,1]; p4 = [649,406,1]; l2 = cross(p3,p4); v4 = cross(l1,l2); v4 = v4/v4(3); v4 = T*v4';

p1 = [497,63,1]; p2 = [497,255,1]; l1 = cross(p1,p2); p3 = [820,373,1]; p4 = [860,207,1]; l2 = cross(p3,p4); v5 = cross(l1,l2); v5 = v5/v5(3); v5 = T*v5';
p1 = [551,316,1]; p2 = [683,385,1]; l1 = cross(p1,p2); p3 = [562,34,1]; p4 = [796,114,1]; l2 = cross(p3,p4); v6 = cross(l1,l2); v6 = v6/v6(3); v6 = T*v6';

p1 = [515,43,1]; p2 = [515,283,1]; l1 = cross(p1,p2); p3 = [827,181,1]; p4 = [773,405,1]; l2 = cross(p3,p4); v7 = cross(l1,l2); v7 = v7/v7(3); v7 = T*v7';
p1 = [394,373,1]; p2 = [287,532,1]; l1 = cross(p1,p2); p3 = [698,463,1]; p4 = [622,681,1]; l2 = cross(p3,p4); v8 = cross(l1,l2); v8 = v8/v8(3); v8 = T*v8';

p1 = [515,43,1]; p2 = [515,283,1]; l1 = cross(p1,p2); p3 = [827,181,1]; p4 = [773,405,1]; l2 = cross(p3,p4); v9 = cross(l1,l2); v9 = v9/v9(3); v9 = T*v9';
p1 = [436,358,1]; p2 = [658,421,1]; l1 = cross(p1,p2); p3 = [302,597,1]; p4 = [539,675,1]; l2 = cross(p3,p4); v10 = cross(l1,l2); v10 = v10/v10(3); v10 = T*v10';

centerx = (v1(1)+v2(1)+v3(1)+v4(1)+v5(1)+v6(1)+v7(1)+v8(1)+v9(1)+v10(1))/10;
centery = (v1(2)+v2(2)+v3(2)+v4(2)+v5(2)+v6(2)+v7(2)+v8(2)+v9(2)+v10(2))/10;
maxi = [0,0];mini = [0,0];
maxi(1) = max([v1(1),v2(1),v3(1),v4(1),v5(1),v6(1),v7(1),v8(1),v9(1),v10(1)]);
mini(2) = min([v1(2),v2(2),v3(2),v4(2),v5(2),v6(2),v7(2),v8(2),v9(2),v10(2)]);
mini(1) = min([v1(1),v2(1),v3(1),v4(1),v5(1),v6(1),v7(1),v8(1),v9(1),v10(1)]);
maxi(2) = max([v1(2),v2(2),v3(2),v4(2),v5(2),v6(2),v7(2),v8(2),v9(2),v10(2)]);
scale = maxi-mini;
T = [1/scale(1),0,(-centerx/scale(1));0,1/scale(2),(-centery/scale(2));0,0,1];
T = [1 0 0;0 1 0;0 0 1];
v1 = T*v1; v2 = T*v2; v3 = T*v3; v4 = T*v4; v5 = T*v5; v6 = T*v6; v7 = T*v7; v8 = T*v8; v9 = T*v9; v10 = T*v10;
%Equation to be solved

A = vpa([v1(1)*v2(1) , v1(1)*v2(2) + v1(2)*v2(1) , v1(2)*v2(2) , v1(1)*v2(3) + v1(3)*v2(1) , v1(2)*v2(3) + v1(3)*v2(2) , v1(3)*v2(3);
     v3(1)*v4(1) , v3(1)*v4(2) + v3(2)*v4(1) , v3(2)*v4(2) , v3(1)*v4(3) + v3(3)*v4(1) , v3(2)*v4(3) + v3(3)*v4(2) , v3(3)*v4(3);
     v5(1)*v6(1) , v5(1)*v6(2) + v5(2)*v6(1) , v5(2)*v6(2) , v5(1)*v6(3) + v5(3)*v6(1) , v5(2)*v6(3) + v5(3)*v6(2) , v5(3)*v6(3);
     v7(1)*v8(1) , v7(1)*v8(2) + v7(2)*v8(1) , v7(2)*v8(2) , v7(1)*v8(3) + v7(3)*v8(1) , v7(2)*v8(3) + v7(3)*v8(2) , v7(3)*v8(3);
     v9(1)*v10(1) , v9(1)*v10(2) + v9(2)*v10(1) , v9(2)*v10(2) , v9(1)*v10(3) + v9(3)*v10(1) , v9(2)*v10(3) + v9(3)*v10(2) , v9(3)*v10(3)]);

 
[U D V] = svd(A);
w = V(:,6);
W = [w(1),w(2),w(4);w(2),w(3),w(5);w(4),w(5),w(6)];
C = W;
W = T'*W*T;
K = chol(W);
K = inv(K);
K = K/K(9);

