%Assuming a full K matrix, use 5 perpendicularity relations between vanishing points to compute camera matrix.

%5 perpendicular directions:
%p1 = []; p2 = []; l1 = cross(p1,p2); p3 = []; p4 = []; l2 = cross(p3,p4); v1 = cross(l1,l2); v1 = v1/v1(3);
%p1 = []; p2 = []; l1 = cross(p1,p2); p3 = []; p4 = []; l2 = cross(p3,p4); v2 = cross(l1,l2); v2 = v2/v2(3);

%p1 = []; p2 = []; l1 = cross(p1,p2); p3 = []; p4 = []; l2 = cross(p3,p4); v3 = cross(l1,l2); v3 = v3/v3(3);
%p1 = []; p2 = []; l1 = cross(p1,p2); p3 = []; p4 = []; l2 = cross(p3,p4); v4 = cross(l1,l2); v4 = v4/v4(3);

%p1 = []; p2 = []; l1 = cross(p1,p2); p3 = []; p4 = []; l2 = cross(p3,p4); v5 = cross(l1,l2); v5 = v5/v5(3);
%p1 = []; p2 = []; l1 = cross(p1,p2); p3 = []; p4 = []; l2 = cross(p3,p4); v6 = cross(l1,l2); v6 = v6/v6(3);

%img1
%imshow('Images/img1.jpg');
%p1 = [324,1836,1]; p2 = [956,1844,1]; l1 = cross(p1,p2); p3 = [260,2324,1]; p4 = [1108,2308,1]; l2 = cross(p3,p4); v1 = cross(l1,l2); v1 = v1/v1(3);
%p1 = [1452,2428,1]; p2 = [1820,3388,1]; l1 = cross(p1,p2); p3 = [4076,2268,1]; p4 = [4780,3172,1]; l2 = cross(p3,p4); v2 = cross(l1,l2); v2 = v2/v2(3);

%p1 = [1524,1556,1]; p2 = [1708,732,1]; l1 = cross(p1,p2); p3 = [4076,1548,1]; p4 = [4516,532,1]; l2 = cross(p3,p4); v3 = cross(l1,l2); v3 = v3/v3(3);
%p1 = [1452,2428,1]; p2 = [1820,3388,1]; l1 = cross(p1,p2); p3 = [4076,2268,1]; p4 = [4780,3172,1]; l2 = cross(p3,p4); v4 = cross(l1,l2); v4 = v4/v4(3);

%p1 = [324,1836,1]; p2 = [956,1844,1]; l1 = cross(p1,p2); p3 = [260,2324,1]; p4 = [1108,2308,1]; l2 = cross(p3,p4); v5 = cross(l1,l2); v5 = v5/v5(3);
%p1 = [1524,1556,1]; p2 = [1708,732,1]; l1 = cross(p1,p2); p3 = [4076,1548,1]; p4 = [4516,532,1]; l2 = cross(p3,p4); v6 = cross(l1,l2); v6 = v6/v6(3);

%img2
%imshow('Images/img2.jpg');
%p1 = [1172,484,1]; p2 = [2468,1556,1]; l1 = cross(p1,p2); p3 = [4156,124,1]; p4 = [4996,644,1]; l2 = cross(p3,p4); v1 = cross(l1,l2); v1 = v1/v1(3);
%p1 = [236,172,1]; p2 = [276,508,1]; l1 = cross(p1,p2); p3 = [3124,2308,1]; p4 = [3108,2836,1]; l2 = cross(p3,p4); v2 = cross(l1,l2); v2 = v2/v2(3);

%p1 = [1172,484,1]; p2 = [2468,1556,1]; l1 = cross(p1,p2); p3 = [4156,124,1]; p4 = [4996,644,1]; l2 = cross(p3,p4); v3 = cross(l1,l2); v3 = v3/v3(3);
%p1 = [2948,1172,1]; p2 = [4172,604,1]; l1 = cross(p1,p2); p3 = [3580,1844,1]; p4 = [5020,1124,1]; l2 = cross(p3,p4); v4 = cross(l1,l2); v4 = v4/v4(3);

%p1 = [3140,2380,1]; p2 = [3132,3012,1]; l1 = cross(p1,p2); p3 = [5380,1172,1]; p4 = [5284,1788,1]; l2 = cross(p3,p4); v5 = cross(l1,l2); v5 = v5/v5(3);
%p1 = [2948,1172,1]; p2 = [4172,604,1]; l1 = cross(p1,p2); p3 = [3580,1844,1]; p4 = [5020,1124,1]; l2 = cross(p3,p4); v6 = cross(l1,l2); v6 = v6/v6(3);

%img7
%imshow('Images/img7.png');
%p1 = [40,150,1]; p2 = [94,349,1]; l1 = cross(p1,p2); p3 = [415,69,1]; p4 = [424,232,1]; l2 = cross(p3,p4); v1 = cross(l1,l2); v1 = v1/v1(3);
%p1 = [118,76,1]; p2 = [328,30,1]; l1 = cross(p1,p2); p3 = [194,378,1]; p4 = [358,330,1]; l2 = cross(p3,p4); v2 = cross(l1,l2); v2 = v2/v2(3);

%p1 = [274,513,1]; p2 = [373,370,1]; l1 = cross(p1,p2); p3 = [664,654,1]; p4 = [712,498,1]; l2 = cross(p3,p4); v3 = cross(l1,l2); v3 = v3/v3(3);
%p1 = [286,604,1]; p2 = [539,693,1]; l1 = cross(p1,p2); p3 = [455,352,1]; p4 = [649,406,1]; l2 = cross(p3,p4); v4 = cross(l1,l2); v4 = v4/v4(3);

%p1 = [497,63,1]; p2 = [497,255,1]; l1 = cross(p1,p2); p3 = [820,373,1]; p4 = [860,207,1]; l2 = cross(p3,p4); v5 = cross(l1,l2); v5 = v5/v5(3);
%p1 = [551,316,1]; p2 = [683,385,1]; l1 = cross(p1,p2); p3 = [562,34,1]; p4 = [796,114,1]; l2 = cross(p3,p4); v6 = cross(l1,l2); v6 = v6/v6(3);

%checkerboard images
%imshow('Images/cb1.jpg');
T = [1 0 0;0 1 0;0 0 1];
p1 = [2964,1508,1]; p2 = [2724,2020,1]; l1 = cross(p1,p2); p3 = [4180,1836,1]; p4 = [3980,2588,1]; l2 = cross(p3,p4); v1 = cross(l1,l2); v1 = v1/v1(3); v1 = T*v1';
p1 = [2284,1892,1]; p2 = [3580,2276,1]; l1 = cross(p1,p2); p3 = [2588,1372,1]; p4 = [3780,1724,1]; l2 = cross(p3,p4); v2 = cross(l1,l2); v2 = v2/v2(3); v2 = T*v2';

p1 = [2220,1900,1]; p2 = [2260,2484,1]; l1 = cross(p1,p2); p3 = [3604,1660,1]; p4 = [3884,2828,1]; l2 = cross(p3,p4); v3 = cross(l1,l2); v3 = v3/v3(3); v3 = T*v3';
p1 = [3884,2828,1]; p2 = [2284,2812,1]; l1 = cross(p1,p2); p3 = [2172,1612,1]; p4 = [3596,1644,1]; l2 = cross(p3,p4); v4 = cross(l1,l2); v4 = v4/v4(3); v4 = T*v4';

p1 = [2852,700,1]; p2 = [2108,2060,1]; l1 = cross(p1,p2); p3 = [4468,924,1]; p4 = [3628,2444,1]; l2 = cross(p3,p4); v5 = cross(l1,l2); v5 = v5/v5(3); v9 = T*v5';
p1 = [1804,2532,1]; p2 = [2940,2876,1]; l1 = cross(p1,p2); p3 = [2868,700,1]; p4 = [4028,868,1]; l2 = cross(p3,p4); v6 = cross(l1,l2); v6 = v6/v6(3); v10 = T*v6';

%Equation to be solved

A = vpa([v1(1)*v2(1)+v1(2)*v2(2),v1(3)*v2(1)+v1(1)*v2(3),v1(2)*v2(3)+v1(3)*v2(2),v1(3)*v2(3);
    v3(1)*v4(1)+v3(2)*v4(2),v3(3)*v4(1)+v3(1)*v4(3),v3(2)*v4(3)+v3(3)*v4(2),v3(3)*v4(3);
    v5(1)*v6(1)+v5(2)*v6(2),v5(3)*v6(1)+v5(1)*v6(3),v5(2)*v6(3)+v5(3)*v6(2),v5(3)*v6(3)]);
%[u1v1+u2v2,u3v1+u13,u2v3+u3v2,u3v3]w = 0.
 
 [U D V] = svd(A);
 w = V(:,4);
 W = [w(1),0,w(2);0,w(1),w(3);w(2),w(3),w(4)];
 W = T'*W*T;
 K = chol(W);
 K = inv(K);
 K = K/K(9);