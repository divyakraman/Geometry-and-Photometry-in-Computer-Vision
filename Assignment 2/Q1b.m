%Homography relations

%p1 = [];
%p2 = [];
%p3 = [];
%p4 = [];
%p1n = [];
%p2n = [];
%p3n = [];
%p4n = [];

%h = homofind(p1,p2,p3,p4,p1n,p2n,p3n,p4n);
%h1 = h(:,1); h2 = h(:,2); h7 = h(:,3);

%p1 = [];
%p2 = [];
%p3 = [];
%p4 = [];
%p1n = [];
%p2n = [];
%p3n = [];
%p4n = [];

%h = homofind(p1,p2,p3,p4,p1n,p2n,p3n,p4n);
%h3 = h(:,1); h4 = h(:,2); h8 = h(:,3);

%p1 = [];
%p2 = [];
%p3 = [];
%p4 = [];
%p1n = [];
%p2n = [];
%p3n = [];
%p4n = [];

%h = homofind(p1,p2,p3,p4,p1n,p2n,p3n,p4n);
%h5 = h(:,1); h6 = h(:,2); h9 = h(:,3);

%Img7
p1 = [59,109];
p2 = [397,34];
p3 = [406,294];
p4 = [125,381];
p1n = [0,1];
p2n = [1,1];
p3n = [1,0];
p4n = [0,0];

[h,T] = homofind(p1,p2,p3,p4,p1n,p2n,p3n,p4n);
h = inv(h);
h1 = h(:,1); h2 = h(:,2); h7 = h(:,3);

p1 = [515,298];
p2 = [769,427];
p3 = [830,156];
p4 = [520,40];
p1n = [0,0];
p2n = [1,0];
p3n = [1,1];
p4n = [0,1];

[h,T] = homofind(p1,p2,p3,p4,p1n,p2n,p3n,p4n);
h = inv(h);
h3 = h(:,1); h4 = h(:,2); h8 = h(:,3);

p1 = [410,358];
p2 = [709,438];
p3 = [617,697];
p4 = [254,577];
p1n = [0,1];
p2n = [1,1];
p3n = [1,0];
p4n = [0,0];

[h,T] = homofind(p1,p2,p3,p4,p1n,p2n,p3n,p4n);
h = inv(h);
h5 = h(:,1); h6 = h(:,2); h9 = h(:,3);

%checker board
p1 = [2820,1828];
p2 = [2908,1660];
p3 = [3292,1780];
p4 = [3236,1964];
p1n = [0,0];
p2n = [0,1];
p3n = [1,1];
p4n = [1,0];

[h,T] = homofind(p1,p2,p3,p4,p1n,p2n,p3n,p4n);
h = inv(h);
h1 = h(:,1); h2 = h(:,2); h7 = h(:,3);

p1 = [3652,2180];
p2 = [3644,2028];
p3 = [4108,2028];
p4 = [4124,2172];
p1n = [0,0];
p2n = [0,1];
p3n = [1,1];
p4n = [1,0];

[h,T] = homofind(p1,p2,p3,p4,p1n,p2n,p3n,p4n);
h = inv(h);
h3 = h(:,1); h4 = h(:,2); h8 = h(:,3);

p1 = [2972,1220];
p2 = [3220,764];
p3 = [3604,828];
p4 = [3356,1284];
p1n = [0,0];
p2n = [0,1];
p3n = [1,1];
p4n = [1,0];

[h,T] = homofind(p1,p2,p3,p4,p1n,p2n,p3n,p4n);
h = inv(h);
h5 = h(:,1); h6 = h(:,2); h9 = h(:,3);

B = vpa([h1(1)*h2(1) , h1(1)*h2(2) + h1(2)*h2(1) , h1(2)*h2(2) , h1(1)*h2(3) + h1(3)*h2(1) , h1(2)*h2(3) + h1(3)*h2(2) , h1(3)*h2(3);
     h1(1)*h1(1)-h2(1)*h2(1) , h1(1)*h1(2) + h1(2)*h1(1)-h2(1)*h2(2) - h2(2)*h2(1) , h1(2)*h1(2)-h2(2)*h2(2) , h1(1)*h1(3) + h1(3)*h1(1)-h2(1)*h2(3) - h2(3)*h2(1) , h1(2)*h1(3) + h1(3)*h1(2)-h2(2)*h2(3) - h2(3)*h2(2) , h1(3)*h1(3)-h2(3)*h2(3);
     h3(1)*h4(1) , h3(1)*h4(2) + h3(2)*h4(1) , h3(2)*h4(2) , h3(1)*h4(3) + h3(3)*h4(1) , h3(2)*h4(3) + h3(3)*h4(2) , h3(3)*h4(3);
     h3(1)*h3(1)-h4(1)*h4(1) , h3(1)*h3(2) + h3(2)*h3(1)-h4(1)*h4(2) - h4(2)*h4(1) , h3(2)*h3(2)-h4(2)*h4(2) , h3(1)*h3(3) + h3(3)*h3(1)-h4(1)*h4(3) - h4(3)*h4(1) , h3(2)*h3(3) + h3(3)*h3(2)-h4(2)*h4(3) - h4(3)*h4(2) , h3(3)*h3(3)-h4(3)*h4(3);
     h5(1)*h6(1) , h5(1)*h6(2) + h5(2)*h6(1) , h5(2)*h6(2) , h5(1)*h6(3) + h5(3)*h6(1) , h5(2)*h6(3) + h5(3)*h6(2) , h5(3)*h6(3)]);
 
 [U D V] = svd(B);
 w = V(:,6);
 W = [w(1),w(2),w(4);w(2),w(3),w(5);w(4),w(5),w(6)];
 K = chol(W);
 K = inv(K);
 K = K/K(9);
 
function [h,T] = homofind(p1,p2,p3,p4,p1n,p2n,p3n,p4n)


%normalise data
p = (p1+p2+p3+p4)/4;
maxi = [0,0];mini = [0,0];
maxi(1) = max([p1(1),p2(1),p3(1),p4(1)]); mini(1) = min([p1(1),p2(1),p3(1),p4(1)]); 
maxi(2) = max([p1(2),p2(2),p3(2),p4(2)]); mini(2) = min([p1(2),p2(2),p3(2),p4(2)]); 
scale = maxi-mini;
T = [1/scale(1),0,(-p(1)/scale(1));0,1/scale(2),(-p(2)/scale(2));0,0,1];
p1 = T*[p1';1];
p2 = T*[p2';1];
p3 = T*[p3';1];
p4 = T*[p4';1];
A = [p1(1) p1(2) 1 0 0 0 -(p1n(1)*p1(1)) -(p1(2)*p1n(1)) -p1n(1);
    0 0 0 -p1(1) -p1(2) -1 (p1n(2)*p1(1)) (p1(2)*p1n(2)) p1n(2);
    p2(1) p2(2) 1 0 0 0 -(p2n(1)*p2(1)) -(p2(2)*p2n(1)) -p2n(1);
    0 0 0 -p2(1) -p2(2) -1 (p2n(2)*p2(1)) (p2(2)*p2n(2)) p2n(2);
    p3(1) p3(2) 1 0 0 0 -(p3n(1)*p3(1)) -(p3(2)*p3n(1)) -p3n(1);
    0 0 0 -p3(1) -p3(2) -1 (p3n(2)*p3(1)) (p3(2)*p3n(2)) p3n(2);
    p4(1) p4(2) 1 0 0 0 -(p4n(1)*p4(1)) -(p4(2)*p4n(1)) -p4n(1);
    0 0 0 -p4(1) -p4(2) -1 (p4n(2)*p4(1)) (p4(2)*p4n(2)) p4n(2)];

[U D V] = svd(A);
h = V(:,9);
h = vec2mat(h,3);
h = h/h(3,3);%scaling factor
h = h*T;%Denormalise data
end


