% Rectify the images upto similarity in a single step by using 4 or 5 perpendicular directions/lines.

%Image 1
%Im1 = imread('Images_Assign1/Image1.JPG');
%l1 = line(2364,1732,2836,2668);
%l2 = line(2836,2668,4004,2308);
%l3 = line(4004,2308,3452,1436);
%l4 = line(3452,1436,4412,1172);
%l5 = line(4412,1172,3908,556);
%l6 = line(3908,556,4708,388);%li is perpendicular to l(i+1)

%Image 2
%Im1 = imread('Images_Assign1/Image2.JPG');
%l1 = line(2308,2540,1100,2116);
%l2 = line(1100,2116,1804,1836);
%l3 = line(1804,1836,212,1228);
%l4 = line(212,1228,1012,716);
%l5 = line(1012,716,2780,1500);
%l6 = line(2780,1500,4220,964);%li is perpendicular to l(i+1)

%Image 3
Im1 = imread('Images_Assign1/Image3.JPG');
l1 = line(3412,3628,4412,3156);
l2 = line(4412,3156,3836,2204);
l3 = line(3836,2204,4620,1932);
l4 = line(4620,1932,4116,1228);
l5 = line(4116,1228,4732,1076);
l6 = line(4732,1076,4300,532);%li is perpendicular to l(i+1)

%Image4
%Im1 = imread('Images_Assign1/Image4.JPG');
%l1 = line(1988,2404,836,2636);
%l2 = line(836,2636,532,1716);
%l3 = line(532,1716,1516,1508);
%l4 = line(1516,1508,1972,2388);

%l5 = line(2692,1780,2860,1060);
%l6 = line(2860,1060,3732,1156);%li is perpendicular to l(i+1)
%l7 = line(3732,1156,3676,1892);

%Image5
%Im1 = imread('Images_Assign1/Image5.JPG');
%l1 = line(2164,3484,1972,1204);
%l2 = line(1972,1204,3972,636);
%l3 = line(3972,636,3956,2204);
%l4 = line(3956,2204,2164,3484);

%l5 = line(4764,580,5260,700);
%l6 = line(5260,700,5156,1188);%li is perpendicular to l(i+1)
%l7 = line(5156,1188,4652,1044);

%Image6
%Im1 = imread('Images_Assign1/image6.png');
%l1 = line(361,40,334,594);
%l2 = line(334,594,582,482);
%l3 = line(582,482,590,161);
%l4 = line(590,161,361,40);

%l5 = line(84,112,78,325);
%l6 = line(78,325,205,332);%li is perpendicular to l(i+1)
%l7 = line(205,332,212,151);


%Image 1,2,3
A = vpa([(l1(1)*l2(1)) (l1(1)*l2(2)+l1(2)*l2(1))/2 (l1(2)*l2(2)) (l1(1)*l2(3)+l1(3)*l2(1))/2 (l1(3)*l2(2)+l1(2)*l2(3))/2  (l1(3)*l2(3));
    (l2(1)*l3(1)) (l2(1)*l3(2)+l2(2)*l3(1))/2 (l2(2)*l3(2)) (l2(1)*l3(3)+l2(3)*l3(1))/2 (l2(3)*l3(2)+l2(2)*l3(3))/2  (l2(3)*l3(3));
    (l3(1)*l4(1)) (l3(1)*l4(2)+l3(2)*l4(1))/2 (l3(2)*l4(2)) (l3(1)*l4(3)+l3(3)*l4(1))/2 (l3(3)*l4(2)+l3(2)*l4(3))/2  (l3(3)*l4(3));
    (l4(1)*l5(1)) (l4(1)*l5(2)+l4(2)*l5(1))/2 (l4(2)*l5(2)) (l4(1)*l5(3)+l4(3)*l5(1))/2 (l4(3)*l5(2)+l4(2)*l5(3))/2  (l4(3)*l5(3));
    (l5(1)*l6(1)) (l5(1)*l6(2)+l5(2)*l6(1))/2 (l5(2)*l6(2)) (l5(1)*l6(3)+l5(3)*l6(1))/2 (l5(3)*l6(2)+l5(2)*l6(3))/2  (l5(3)*l6(3))]);

%Image 4,5,6
%    A = vpa([(l1(1)*l2(1)) (l1(1)*l2(2)+l1(2)*l2(1))/2 (l1(2)*l2(2)) (l1(1)*l2(3)+l1(3)*l2(1))/2 (l1(3)*l2(2)+l1(2)*l2(3))/2  (l1(3)*l2(3));
% (l2(1)*l3(1)) (l2(1)*l3(2)+l2(2)*l3(1))/2 (l2(2)*l3(2)) (l2(1)*l3(3)+l2(3)*l3(1))/2 (l2(3)*l3(2)+l2(2)*l3(3))/2  (l2(3)*l3(3));
%  (l3(1)*l4(1)) (l3(1)*l4(2)+l3(2)*l4(1))/2 (l3(2)*l4(2)) (l3(1)*l4(3)+l3(3)*l4(1))/2 (l3(3)*l4(2)+l3(2)*l4(3))/2  (l3(3)*l4(3));
%   (l6(1)*l7(1)) (l6(1)*l7(2)+l6(2)*l7(1))/2 (l6(2)*l7(2)) (l6(1)*l7(3)+l6(3)*l7(1))/2 (l6(3)*l7(2)+l6(2)*l7(3))/2  (l6(3)*l7(3));
%    (l5(1)*l6(1)) (l5(1)*l6(2)+l5(2)*l6(1))/2 (l5(2)*l6(2)) (l5(1)*l6(3)+l5(3)*l6(1))/2 (l5(3)*l6(2)+l5(2)*l6(3))/2  (l5(3)*l6(3))]);
c = null(A);
C = [c(1) c(2)/2 c(4)/2;
    c(2)/2 c(3) c(5)/2;
    c(4)/2 c(5)/2 c(6)];
[U D V] = svd(C);
h = U;
h = double(h);
tform = projective2d(inv(h'));
%Im1 = imread('im4.jpg');
Im1 = imresize(Im1,0.05);
J = imwarp(Im1,tform);
figure
imshow(J)

    



function l = line(x1,y1,x2,y2)
l = [(y2-y1) (x1-x2) ((-x1*y2)+(y1*x2))];
end
